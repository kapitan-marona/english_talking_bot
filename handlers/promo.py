from telegram import Update
from telegram.ext import ContextTypes
from handlers.conversation import promo_completed

from datetime import datetime

PROMO_EXPIRATION = datetime(2025, 8, 26)

def is_expired():
    return datetime.now() > PROMO_EXPIRATION

VALID_PROMOCODES = {
    "–¥—Ä—É–≥": "–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–Ω—è—Ç! üéÅ –î—Ä—É–∂–µ—Å–∫–∏–π –±–æ–Ω—É—Å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –¥–æ 26.08!",
    "—Ç–µ—Å—Ç–æ–≤—ã–π": "üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω",
    "0917": "üîì –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å üëë"
}
USED_PROMOCODES = set()

async def promo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args:
        await update.message.reply_text(
            "–ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥, –≤–≤–µ–¥–∏ –µ–≥–æ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /promo.\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: /promo code"
        )
        return

    code = update.message.text.replace("/promo", "").strip().lower()
    user_id = update.effective_user.id
    promo_key = f"{user_id}:{code}"

    if code not in ["0917", "—Ç–µ—Å—Ç–æ–≤—ã–π"] and is_expired():
        await update.message.reply_text("‚è∞ –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—Ç—ë–∫. –ù–æ –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π ‚Äî —Å–∫–æ—Ä–æ –±—É–¥—É—Ç –Ω–æ–≤—ã–µ!")
        return

    if code not in ["0917", "—Ç–µ—Å—Ç–æ–≤—ã–π"] and promo_key in USED_PROMOCODES:
        await update.message.reply_text("‚ö†Ô∏è –≠—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω.")
        return

    USED_PROMOCODES.add(promo_key)
    await update.message.reply_text(f"‚úÖ {VALID_PROMOCODES.get(code, 'üéâ')}")

    user_lang = update.effective_user.language_code or "en"
    if user_lang.startswith("ru"):
        await update.message.reply_text("""–ü—Ä–∏–≤–µ—Ç, –¥—Ä—É–≥! üññ
    –ß–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É –Ω–∞—á–Ω—ë—Ç—Å—è —Ç–≤–æ—è –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∞—è –±–µ—Å–µ–¥–∞ —Å –±–æ—Ç–æ–º-–∫–æ–º–ø–∞–Ω—å–æ–Ω–æ–º. –û—á–µ–Ω—å –Ω–∞–¥–µ—é—Å—å, –≤—ã –ø–æ–¥—Ä—É–∂–∏—Ç–µ—Å—å ‚Äî –æ–Ω —Å—Ç–∞—Ä–∞–µ—Ç—Å—è –Ω–µ –∑—Ä—è!

    –í–æ—Ç —á—Ç–æ –æ–Ω —É–º–µ–µ—Ç (–∏ –¥–∞–∂–µ –Ω–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ):

    ‚Ä¢ üí¨ –ø–æ–¥–¥–µ—Ä–∂–∏—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã ‚Äî –æ—Ç ¬´–ø—Ä–∏–≤–µ—Ç¬ª –¥–æ ¬´–∞ –≤ —á—ë–º —Å–º—ã—Å–ª –∂–∏–∑–Ω–∏?¬ª
    ‚Ä¢ ‚úçÔ∏è –∏—Å–ø—Ä–∞–≤–∏—Ç, –ø–æ–¥—Å–∫–∞–∂–µ—Ç –∏ –Ω–µ –æ—Å—É–¥–∏—Ç, –µ—Å–ª–∏ –Ω–∞–ø–∏—à–µ—à—å —Å –º–∏—Å—Å–∫–ª–∏–∫–æ–º –∏–ª–∏ –æ—à–∏–±–∫–æ–π
    ‚Ä¢ üìö —Å—Ç–∞—Ä–∞–µ—Ç—Å—è –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∑–∞–Ω–æ—Å–∏—Ç—å –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ —Å–ª–æ–≤–∞—Ä–∏–∫ (—Å–∞–º, –º–µ–∂–¥—É –ø—Ä–æ—á–∏–º!)
    ‚Ä¢ üåç –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–≤–æ–∏–º –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–æ–º ‚Äî —Å–ª–æ–≤, —Ñ—Ä–∞–∑ –∏–ª–∏ —Ü–µ–ª—ã—Ö –∞–±–∑–∞—Ü–µ–≤
    ‚Ä¢ üá∑üá∫ –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥—Ç—è–Ω—É—Ç—å —Ä—É—Å—Å–∫–∏–π ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –æ–Ω —Ç–µ–±–µ –Ω–µ —Ä–æ–¥–Ω–æ–π
    ‚Ä¢ üß† –º–æ–∂–µ—Ç –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è ‚Äî –∫–∞–∫ –ª–∏—á–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä, –ª—é–±—è
    ‚Ä¢ üéô –æ–±—â–∞–µ—Ç—Å—è –≥–æ–ª–æ—Å–æ–º –ø–æ—á—Ç–∏ –Ω–∞ –≤—Å–µ—Ö —è–∑—ã–∫–∞—Ö (—Ñ–∏–Ω—Å–∫–∏–π –∏ –Ω–æ—Ä–≤–µ–∂—Å–∫–∏–π –ø–æ–∫–∞ –æ—Ç–¥—ã—Ö–∞—é—Ç, sorry)
    ‚Ä¢ üé≠ —à—É—Ç–∏—Ç –∏ –ø–æ–¥–Ω–∏–º–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –µ—Å–ª–∏ –≤—ã –≤ —Ä–µ–∂–∏–º–µ casual), –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–≥ –∏ –¥–µ–ª–æ–≤–∏—Ç ‚Äî –¥–ª—è —Ä–µ–∂–∏–º–∞ formal
    ‚Ä¢ üß™ —É–º–µ–µ—Ç –º–Ω–æ–≥–æ –±–æ–ª—å—à–µ, —á–µ–º —Ç—ã –¥—É–º–∞–µ—à—å. –ù–µ –±–æ–π—Å—è –ø—Ä–æ–≤–µ—Ä—è—Ç—å ‚Äî —Ç—ã –µ–≥–æ –Ω–µ —Å–ª–æ–º–∞–µ—à—å.

    –û–Ω –Ω–µ –ª—é–±–∏—Ç —Ç–æ—Ä–æ–ø–∏—Ç—å—Å—è, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏–Ω–∏–º–∞–µ—Ç 1 —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –∫–æ–º–∞–Ω–¥—É –∑–∞ 3 —Å–µ–∫—É–Ω–¥—ã.
    –û–º–æ–∂–µ—Ç –æ—à–∏–±–∞—Ç—å—Å—è. –ù–æ —Å –∫–∞–∂–¥—ã–º —Ä–∞–∑–æ–º –≤—Å—ë –º–µ–Ω—å—à–µ. 
    """)
    else:
        await update.message.reply_text("""Hey there, friend! üññ
    You're just moments away from chatting with your new companion bot. I hope you two get along ‚Äî he's really trying his best!

    Here's what he can do (and even more):

    ‚Ä¢ üí¨ Chat with you on any topic ‚Äî from ‚Äúhi‚Äù to ‚Äúwhat's the meaning of life?‚Äù
    ‚Ä¢ ‚úçÔ∏è Gently correct and explain mistakes ‚Äî no judgment if you mistype
    ‚Ä¢ üìö Automatically keeps a personal dictionary of new words for you (yes, by himself!)
    ‚Ä¢ üåç Act as your personal translator ‚Äî words, phrases, or whole paragraphs
    ‚Ä¢ üá¨üáß Help you improve your English ‚Äî especially if it‚Äôs not your first language
    ‚Ä¢ üß† Invent learning tasks like a loving personal coach
    ‚Ä¢ üéô Speak in almost every language (except Finnish and Norwegian ‚Äî they‚Äôre on vacation)
    ‚Ä¢ üé≠ Be playful and fun in casual mode, or serious and formal if you prefer
    ‚Ä¢ üß™ Do way more than you expect. Don‚Äôt be afraid to test him ‚Äî you won‚Äôt break anything.

    He‚Äôs slow and steady ‚Äî one message or command every 3 seconds.
    And yes, he might make mistakes. But he gets better every time.
    """)

    return await promo_completed(update, context)



from telegram import Update
from telegram.ext import ContextTypes
from handlers.conversation import promo_completed

from datetime import datetime

PROMO_EXPIRATION = datetime(2025, 8, 26)

def is_expired():
    return datetime.now() > PROMO_EXPIRATION

VALID_PROMOCODES = {
    "–¥—Ä—É–≥": "–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–Ω—è—Ç! üéÅ –î—Ä—É–∂–µ—Å–∫–∏–π –±–æ–Ω—É—Å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –¥–æ 26.08!",
    "–¢–ï–°–¢–û–í–´–ô": "üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω",
    "0917": "üîì –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω üëë"
}
USED_PROMOCODES = set()

async def promo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args:
        await update.message.reply_text(
            "–ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥, –≤–≤–µ–¥–∏ –µ–≥–æ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /promo.\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: /promo code"
        )
        return

    code = update.message.text.replace("/promo", "").strip().upper()
    user_id = update.effective_user.id
    promo_key = f"{user_id}:{code}"

    if code not in ["0917", "–¢–ï–°–¢–û–í–´–ô"] and is_expired():
        await update.message.reply_text("‚è∞ –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—Ç—ë–∫. –ù–æ –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π ‚Äî —Å–∫–æ—Ä–æ –±—É–¥—É—Ç –Ω–æ–≤—ã–µ!")
        return

    if code not in ["0917", "–¢–ï–°–¢–û–í–´–ô"] and promo_key in USED_PROMOCODES:
        await update.message.reply_text("‚ö†Ô∏è –≠—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω.")
        return

    USED_PROMOCODES.add(promo_key)
    await update.message.reply_text(f"‚úÖ {VALID_PROMOCODES.get(code, 'üéâ')}")

    await update.message.reply_text("""–ü—Ä–∏–≤–µ—Ç, –¥—Ä—É–≥! üññ
–ß–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É –Ω–∞—á–Ω—ë—Ç—Å—è —Ç–≤–æ—è –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∞—è –±–µ—Å–µ–¥–∞ —Å –±–æ—Ç–æ–º-–∫–æ–º–ø–∞–Ω—å–æ–Ω–æ–º. –û—á–µ–Ω—å –Ω–∞–¥–µ—é—Å—å, –≤—ã –ø–æ–¥—Ä—É–∂–∏—Ç–µ—Å—å ‚Äî –æ–Ω —Å—Ç–∞—Ä–∞–µ—Ç—Å—è –Ω–µ –∑—Ä—è!

–í–æ—Ç —á—Ç–æ –æ–Ω —É–º–µ–µ—Ç (–∏ –¥–∞–∂–µ –Ω–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ):

‚Ä¢ üí¨ –ø–æ–¥–¥–µ—Ä–∂–∏—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã ‚Äî –æ—Ç ¬´–ø—Ä–∏–≤–µ—Ç¬ª –¥–æ ¬´–∞ –≤ —á—ë–º —Å–º—ã—Å–ª –∂–∏–∑–Ω–∏?¬ª
‚Ä¢ ‚úçÔ∏è –∏—Å–ø—Ä–∞–≤–∏—Ç, –ø–æ–¥—Å–∫–∞–∂–µ—Ç –∏ –Ω–µ –æ—Å—É–¥–∏—Ç, –µ—Å–ª–∏ –Ω–∞–ø–∏—à–µ—à—å —Å –º–∏—Å—Å–∫–ª–∏–∫–æ–º –∏–ª–∏ –æ—à–∏–±–∫–æ–π
‚Ä¢ üìö –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∑–∞–Ω–æ—Å–∏—Ç –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ —Å–ª–æ–≤–∞—Ä–∏–∫ (—Å–∞–º, –º–µ–∂–¥—É –ø—Ä–æ—á–∏–º!)
‚Ä¢ üåç –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–≤–æ–∏–º –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–æ–º ‚Äî —Å–ª–æ–≤, —Ñ—Ä–∞–∑ –∏–ª–∏ —Ü–µ–ª—ã—Ö –∞–±–∑–∞—Ü–µ–≤
‚Ä¢ üá∑üá∫ –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥—Ç—è–Ω—É—Ç—å —Ä—É—Å—Å–∫–∏–π ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –æ–Ω —Ç–µ–±–µ –Ω–µ —Ä–æ–¥–Ω–æ–π
‚Ä¢ üß† –º–æ–∂–µ—Ç –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è ‚Äî –∫–∞–∫ –ª–∏—á–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä, –ª—é–±—è
‚Ä¢ üéô –æ–±—â–∞–µ—Ç—Å—è –≥–æ–ª–æ—Å–æ–º –ø–æ—á—Ç–∏ –Ω–∞ –≤—Å–µ—Ö —è–∑—ã–∫–∞—Ö (—Ñ–∏–Ω—Å–∫–∏–π –∏ –Ω–æ—Ä–≤–µ–∂—Å–∫–∏–π –ø–æ–∫–∞ –æ—Ç–¥—ã—Ö–∞—é—Ç, sorry)
‚Ä¢ üé≠ —É–º–µ–µ—Ç —à—É—Ç–∏—Ç—å –∏ —Ñ–ª–∏—Ä—Ç–æ–≤–∞—Ç—å (–µ—Å–ª–∏ –≤—ã –≤ —Ä–µ–∂–∏–º–µ casual), –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–≥ –∏ –¥–µ–ª–æ–≤–∏—Ç ‚Äî –¥–ª—è —Ä–µ–∂–∏–º–∞ formal
‚Ä¢ üß™ —É–º–µ–µ—Ç –º–Ω–æ–≥–æ –±–æ–ª—å—à–µ, —á–µ–º —Ç—ã –¥—É–º–∞–µ—à—å. –ù–µ –±–æ–π—Å—è –ø—Ä–æ–≤–µ—Ä—è—Ç—å ‚Äî —Ç—ã –µ–≥–æ –Ω–µ —Å–ª–æ–º–∞–µ—à—å.

–ò –≥–ª–∞–≤–Ω–æ–µ: –æ–Ω –º–æ–∂–µ—Ç –æ—à–∏–±–∞—Ç—å—Å—è. –ù–æ —Å –∫–∞–∂–¥—ã–º —Ä–∞–∑–æ–º –≤—Å—ë –º–µ–Ω—å—à–µ.
""")

    return await promo_completed(update, context)

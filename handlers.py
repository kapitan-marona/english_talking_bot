from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove, KeyboardButton
from telegram.ext import ConversationHandler, ContextTypes
from config import client
from google.cloud import texttospeech
import aiofiles
import tempfile
import os
import subprocess

LEARN_LANG, LEVEL, STYLE = range(3)

voice_mode_button = ReplyKeyboardMarkup(
    [[KeyboardButton("ðŸ”Š Voice mode")]], resize_keyboard=True
)
text_mode_button = ReplyKeyboardMarkup(
    [[KeyboardButton("âŒ¨ï¸ Text mode")]], resize_keyboard=True
)

learn_lang_keyboard = [
    ["English", "French", "Spanish", "German", "Italian"],
    ["Finnish", "Norwegian", "Swedish", "Russian", "Portuguese"]
]
learn_lang_markup = ReplyKeyboardMarkup(learn_lang_keyboard, one_time_keyboard=True, resize_keyboard=True)

level_keyboard = [["A1-A2", "B1-B2"]]
level_markup = ReplyKeyboardMarkup(level_keyboard, one_time_keyboard=True, resize_keyboard=True)

style_keyboard_ru = [["Casual", "Formal"]]

LANG_CODES = {
    "English": "en", "French": "fr", "Spanish": "es", "German": "de", "Italian": "it",
    "Portuguese": "pt", "Finnish": "fi", "Norwegian": "no", "Swedish": "sv", "Russian": "ru"
}

WHISPER_SUPPORTED_LANGS = {
    "en", "fr", "es", "de", "it", "pt", "sv", "ru"
}

UNSUPPORTED_LANGUAGE_MESSAGE = {
    "Ð ÑƒÑÑÐºÐ¸Ð¹": "Ð­Ñ‚Ð¾Ñ‚ ÑÐ·Ñ‹Ðº Ð¿Ð¾ÐºÐ° Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð´Ð»Ñ Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÑ‡Ð¸. Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°Ñ‚ÑŒ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼, Ð½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð½ÑƒÐ¶Ð½Ð¾ Ð² Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð¼ Ð²Ð¸Ð´Ðµ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð¹ Ð²Ð²Ð¾Ð´ Ð½Ð° ÐºÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ðµ â€” Ð¾Ð½ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÑ‚ Ð²Ð°ÑˆÑƒ Ñ€ÐµÑ‡ÑŒ Ð² Ñ‚ÐµÐºÑÑ‚, Ð° Ð±Ð¾Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð¼!",
    "English": "This language is not yet supported for voice recognition. You can keep using voice mode, but please send your questions as text. Try using voice input on your keyboard â€” it will convert your speech to text, and the bot will reply with voice!"
}

def generate_system_prompt(interface_lang, level, style, learn_lang, voice_mode=False):
    native_lang = "Russian" if interface_lang == "Ð ÑƒÑÑÐºÐ¸Ð¹" else "English"
    mode = "voice" if voice_mode else "text"
    return f"You are a helpful assistant for learning {learn_lang}. Always respond in {learn_lang}."

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data.clear()
    user_locale = update.effective_user.language_code or "en"
    lang = "Ð ÑƒÑÑÐºÐ¸Ð¹" if user_locale.startswith("ru") else "English"
    context.user_data["language"] = lang

    await update.message.reply_text(
        "Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð¸Ð·ÑƒÑ‡Ð°ÐµÐ¼Ñ‹Ð¹ ÑÐ·Ñ‹Ðº:" if lang == "Ð ÑƒÑÑÐºÐ¸Ð¹" else "Choose a language to learn:",
        reply_markup=learn_lang_markup
    )
    return LEARN_LANG

async def learn_lang_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data["learn_lang"] = update.message.text
    lang = context.user_data["language"]
    await update.message.reply_text(
        "Ð’Ñ‹Ð±ÐµÑ€Ð¸ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ ÑÐ·Ñ‹ÐºÐ°:" if lang == "Ð ÑƒÑÑÐºÐ¸Ð¹" else "Choose your level:",
        reply_markup=level_markup
    )
    return LEVEL

async def level_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data["level"] = update.message.text
    lang = context.user_data["language"]
    await update.message.reply_text(
        "Ð’Ñ‹Ð±ÐµÑ€Ð¸ ÑÑ‚Ð¸Ð»ÑŒ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:" if lang == "Ð ÑƒÑÑÐºÐ¸Ð¹" else "Choose your conversation style:",
        reply_markup=ReplyKeyboardMarkup(style_keyboard_ru, one_time_keyboard=True, resize_keyboard=True)
    )
    return STYLE

async def style_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data["style"] = update.message.text
    context.user_data["voice_mode"] = False
    context.user_data["mode_button_shown"] = False

    lang = context.user_data["language"]
    msg = (
        "ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾, Ð´Ð°Ð²Ð°Ð¹ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾Ð±Ð¾Ð»Ñ‚Ð°ÐµÐ¼! ðŸ˜Ž Ð¡ Ñ‡ÐµÐ³Ð¾ Ñ…Ð¾Ñ‡ÐµÑˆÑŒ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ?"
        if lang == "Ð ÑƒÑÑÐºÐ¸Ð¹" else
        "Great! Let's chat. What would you like to start with?"
    )
    await update.message.reply_text(msg, reply_markup=ReplyKeyboardRemove())

    prompt = generate_system_prompt(
        interface_lang=context.user_data["language"],
        level=context.user_data["level"],
        style=context.user_data["style"],
        learn_lang=context.user_data["learn_lang"],
        voice_mode=False
    )
    context.user_data["system_prompt"] = prompt
    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text("Ð”Ð¸Ð°Ð»Ð¾Ð³ Ð¾Ñ‚Ð¼ÐµÐ½Ñ‘Ð½.", reply_markup=ReplyKeyboardRemove())
    return ConversationHandler.END
